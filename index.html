<!DOCTYPE html>
<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<style>
   /*@import url('https://fonts.googleapis.com/css?family=Oswald&effect=shadow-multiple');*/
body {
    background-color: rgb(255, 255, 255);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
h1 {
    text-align: center;
    padding: 15px;
    background-color: #ffffff;
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
}
</style>

</head>
<body>
   <br>
   <div class="container" id="paraPDF">
      <div class="row">
            <h1>El Arqui Emma</h1>
            <p><strong>Datos del Presupuesto</strong></p>
            <div class="row">
               <div class="col-md-12">
            <input type="text" name="nombre_proyecto" id="proyecto" placeholder="Nombre del Proyecto: " class="form-control" value="Nombre del Proyecto: ">
            <br>
            <input type="text" name="cliente" id="cliente" placeholder="Nombre del Cliente" class="form-control" value="Nombre del Cliente: ">
            <br>
            </div>
            </div>
            <hr>

            <table class="table table-bordered" id="tabla_datos">
               <thead>
                  <th>Num</th>
                  <th>Concepto</th>
                  <th>Cantidad</th>
                  <th>Precio</th>
                  <th>Subtotal</th>
               </thead>
               <tbody id="filas">

               </tbody>
            </table>

            <table class="table">
               <th colspan="4"><strong>Total = </strong></th>
               <th colspan="1" style="text-align: right;"><input class="form-control" type="number" id="gran_total" value="0" style="text-align: right;"></th>
            </table>
            <hr>

            <br>
            <br>
            <br>

            <div style="text-align: right; font-size: 14px;">
               <strong>Atentamente </strong><span> -- Arq. Jesus Emmanuel de la Cruz Palacios</span>
            </div>
            <br>
            <br>
            <div style="text-align: right; font-size: 12px;">
               <strong>Nota:</strong><span>Este presupuesto es valido unicamente 20 d√≠as naturales posteriores a la fecha de entrega</span>
            </div>
            
      </div>
   </div>


      <div class="container">
         <div class="row">
         <p><strong>Agregar Concepto</strong></p>
            <fieldset id="contenido" class="form-inline">
            <div name="registro" id="registro[]" name="registro[]" class="form-inline">
               <input hidden value="1" name="numero" id="numero">
               <input type="text" placeholder="Concepto" name="concepto[]" id="concepto" class="form-control">
               <input type="number" placeholder="Cantidad" name="cantidad[]" id="cantidad" value="1" onchange="calcular(this.parentElement)" class="form-control" >
               <input type="number" placeholder="Precio Unitario" name="preciounit[]" id="preciounit" onchange="calcular(this.parentElement)" class="form-control">
               <input type="number" readonly name="subtotal[]" id="total" placeholder="Subtotal" class="form-control">
               <button onclick="agregar_fila(this.parentElement)" class="btn btn-primary">Agregar</button>
            </div>
            <br>
            </fieldset>
            <hr>
         <!--<button onclick="agregar_registro()">+</button>-->
         <button onclick="genPDF()" class="btn btn-secondary" style="width: 25%; margin: auto;">Generar Presupuesto</button>
      </div>
   </div>

</body>



 <script src="dist/jspdf.min.js"></script>
 <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
 <script src='dist/jspdf.debug.js'></script>
 <script type="text/javascript" src="dist/html2canvas.js"></script>
 <script>
   
var proyecto= document.getElementById("proyecto");
var cliente= document.getElementById("cliente");
let contador=document.getElementById("numero").value;


var contenido= document.getElementById("contenido");
var filas= document.getElementById("filas");

var conceptos = [];
var cant = [];
var preciosu = [];
var subtotales = [];
var tot=0;
var cosas=[];



function llenar_datos(parent){ 

  // for(var i=0;i<cantidad.length;i++){
      conceptos.push(parent.childNodes[3].value);
      cant.push(parent.childNodes[5].value);
      preciosu.push(parent.childNodes[7].value);
      subtotales.push(parent.childNodes[9].value);
  // }

 //  console.log("Cantidades : "+cant+ "Conceptos: "+conceptos);

}


var generateData = function(amount) {
  var result = [];
  var data = {
    num: "1",
    concepto: "GameGroup",
    unidad: "XPTO2",
    precio_u: "25",
    subtotal: "20485861"
  };
  for (var i = 0; i < amount; i += 1) {
    data.id = (i + 1).toString();
    result.push(Object.assign({}, data));
  }
  return result;
};

function createHeaders(keys) {
  var result = [];
  for (var i = 0; i < keys.length; i += 1) {
    result.push({
      id: keys[i],
      name: keys[i],
      prompt: keys[i],
      width: 20,
      align: "center",
      padding: 0
    });
  }
  return result;
}

 function creaPDF(){
   //llenar_datos();
   var pdf = new jsPDF();//'p', 'pt', 'letter'
    //var doc = new jsPDF();
    pdf.setFontSize(10);
    
    pdf.text(20,30, "Proyecto: "+proyecto.value);
    
    pdf.setFontSize(10);
    pdf.text(20,40, "Nombre del Cliente: "+cliente.value);

    for(i=0; i<cant.length; i++){
     // pdf.text(20,45, "Cantidad: "+ cant[i]);
    }
    
    
		//var width = 800;
	//	document.body.style.width = width + "px";

	/*	pdf.fromHTML(document.body,{
			callback: function (pdf) {
				var iframe = document.createElement('iframe');
				iframe.setAttribute('style', 'position:absolute;right:0; top:0; bottom:0; height:100%; width:800px');
				document.body.appendChild(iframe);
				iframe.src = pdf.output('datauristring');
				
			}
		});*/

      var headers = createHeaders([
  "num",
  "concepto",
  "unidad",
  "precio_u",
  "subtotal"
]);

      pdf.table(20, 50, generateData(cant.length), headers, {  autoSize: true });

   pdf.save(proyecto.value+'.pdf');
 }

 function agregar_registro(){
   contenido.innerHTML+='<div name="registro" id="registro[]" name="registro[]">\
   <label for="concepto" ><span>'+contador+'</span></label>\
   <input type="text" placeholder="Concepto" name="concepto[]" id="concepto">\
   <input type="number" placeholder="Cantidad" name="cantidad[]" id="cantidad" value="1" onchange="calcular(this.parentElement)">\
   <input type="number" placeholder="Precio Unitario" name="preciounit[]" id="preciounit" onchange="calcular(this.parentElement)">\
   <input type="number" readonly name="subtotal[]" id="total" placeholder="Subtotal" >\
</div>';
contador=parseFloat(contador)+parseFloat(1);
 }

 function agregar_fila(parent){
   tot=0;
   //document.getElementById("gran_total").value('');
   llenar_datos(parent);
   //var tot=0;
   subtotales.forEach(function(a){tot += parseFloat(a);});
   t=document.getElementById("gran_total");
   t.value=tot;
   //console.log("Total= "+tot);
   //t.value(tot);
//console.log(parent.childNodes)
filas.innerHTML+='<tr>\
   <td>'+contador+'</td>\
   <td>'+parent.childNodes[3].value+'</td>\
   <td style="text-align: center;">'+parent.childNodes[5].value+'</td>\
   <td style="text-align: right;">'+parent.childNodes[7].value+'</td>\
   <td style="text-align: right;">'+parent.childNodes[5].value *  parent.childNodes[7].value+'</td>\
   ';
   contador=parseFloat(contador)+parseFloat(1);

   parent.childNodes[3].value='';
   parent.childNodes[7].value='';
   parent.childNodes[9].value='';
   parent.childNodes[3].focus();
}


 function calcular(parent){
 // var elem= parent.getElementById("numero");getElementsByTagName
 console.log(parent.childNodes);
   var subtotal= parent.childNodes[5].value *  parent.childNodes[7].value;
   parent.childNodes[9].value = subtotal;
   console.log(subtotal);
 }


 </script>



  <script type="text/javascript">
  function genPDF()
  {
   var data = document.getElementById('paraPDF');
    html2canvas(data).then(canvas => {
      var imgWidth = 200;
      var pageHeight = 170;
      var imgHeight = canvas.height * imgWidth / canvas.width;
      var heightLeft = imgHeight;
      const contentDataURL = canvas.toDataURL('image/png', 15)
      var options = {
      size: '100px',
      background: '#fff',
      pagesplit: true,
    };
    let pdf = new jsPDF('p', 'mm', 'a4', 1); // A4 size page of PDF
    var position = 15;//posicion de arriba
    var width = pdf.internal.pageSize.width;
    var height = pdf.internal.pageSize.height;
    pdf.addImage(contentDataURL, 'PNG', 2, position, imgWidth, imgHeight, options)
    pdf.addImage(contentDataURL, 'PNG', 2, position, imgWidth, imgHeight, options);
    heightLeft -= pageHeight;
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(contentDataURL, 'PNG', 2, position, imgWidth, imgHeight, options);
      heightLeft -= pageHeight;
    }
    pdf.save('informe.pdf'); // Generated PDF
    });
   }

  </script>

</html>
